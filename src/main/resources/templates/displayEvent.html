<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${eventCard.eventTitle} + ' | Vistaseat.com'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

    <div th:insert="~{fragments/header :: header}"></div>

    <!-- Alert message for seat unavailability -->
    <div th:if="${error}" class="alert alert-danger" id="access-denied-alert" th:text="${error} "></div>

    <!--Event Details Section-->
    <section class="container my-5 border rounded shadow-lg">
        <div class="event-page-hero">
            <figure class="event-page-image my-2">
                <img th:src="@{${eventCard.eventImageURL}}" th:alt="${eventCard.eventType}">
            </figure>
            <div class="event-page-hero-details gap-3">
                <span class="badge rounded-pill text-bg-light border border-dark my-2">
                    <span class="text-bg-light" th:text="${eventCard.eventType}">CONCERT</span>
                </span>
                <h2 class="two-column-span fw-bold mb-2" th:text="${eventCard.eventTitle}"></h2>
                <div class="event-meta">
                                <span class="meta-label-event-page">
                                    <i class="bi bi-geo-fill"></i>
                                    Venue:
                                </span>
                    <span class="meta-value-event-page" th:text="${eventCard.eventVenueName}">Athens Open Theatre</span>

                    <span class="meta-label-event-page">
                                    <i class="bi bi-calendar-week"></i>
                                    Date:
                    </span>
                    <span class="meta-value-event-page"
                          th:text="'From ' +${#temporals.format(eventCard.fromDate,'MMM d, yyyy')}">
                        14 Aug 2025
                    </span>
                    <span class="meta-label-event-page">
                                    <i class="bi bi-hourglass"></i>
                                    Duration:
                                </span>
                    <span class="meta-value-event-page"
                          th:text="|${eventCard.duration / 60}h ${eventCard.duration % 60}m|">2h 30m</span>

                    <span class="meta-label-event-page">
                                    <i class="bi bi-cash-coin"></i>
                                    Price:
                                </span>
                    <span class="meta-value-event-page"
                          th:text="'From ' + ${eventCard.price} + '€'">€45.00</span>
                </div>
            </div>
        </div>
    </section>
    <!-- About Section -->
    <section class="container my-5" id="aboutSection">
        <h3 class="fw-bold my-3">About this Event</h3>
        <p class="about-event-text" th:text="${eventCard.eventDescription}">
            Event Description
        </p>
    </section>

    <!-- Available Showtimes section -->
    <section class="container my-5">
        <div class="d-flex my-4 gap-3">
            <h2 class="fw-bold m-0">Available Showtimes</h2>
            <div class="d-flex gap-3 ms-auto align-items-stretch">
                <button class="btn btn-outline-dark h-100" type="button" id="clearFilterBtn"
                        th:classappend="${from == null or to == null} ? 'd-none' : ''">
                    Clear Filter
                </button>
                <form class="mb-0" id="dateForm">
                    <div class="col-auto form-floating position-relative">
                        <input id="rangePicker"
                               type="text"
                               class="form-control"
                               size="21"
                               placeholder="From ... to..."
                               th:attr="data-from=${from}, data-to=${to}">
                        <label for="rangePicker">
                            <i class="bi bi-calendar-week me-1"></i>
                            Filter By Date
                        </label>
                    </div>
                    <!-- Hidden fields actually sent to the server -->
                    <input type="hidden" name="from" id="fromHidden" th:value="${from}">
                    <input type="hidden" name="to"   id="toHidden"   th:value="${to}">
                </form>
            </div>
        </div>

        <div th:if="${occurrenceCount == 0}"
             class="empty-state d-flex flex-column align-items-center text-center">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="bi bi-calendar3 empty-icon mb-3" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2M1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384
                 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857z"/>
                <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3
                 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3
                 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3
                 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3
                 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2m3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
            </svg>
            <h3 class="fw-semibold mb-1">Sorry, no occurrences found!</h3>
        </div>
        <!-- Event Occurrences -->
        <div th:each="occurrenceCard :${occurrenceCards}"
             class="text-decoration-none mb-4">
            <div class="book-occurrence-card">
                <div class="availability-ribbon"
                     th:classappend="${occurrenceCard.availabilityLevel.color}"></div>
                <div class="occurrence-details-grid col-lg-6 col-md-4 col-ms-2 mx-2">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-calendar-event me-2"></i>
                        <span th:text="${#temporals.format(occurrenceCard.dateTime, 'EEEE, MMM d, yyyy')}"
                              class="fw-semibold mb-0">Wednesday, Dec 23, 2024</span>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-clock me-2"></i>
                        <span th:text="${#temporals.format(occurrenceCard.dateTime, 'h:mm a')}"
                              class="fw-semibold mb-0">7:30 PM</span>
                    </div>
                    <div class="d-flex align-items-center mb-0 two-column-span">
                        <i class="bi bi-geo-alt me-2"></i>
                        <span th:text="${occurrenceCard.venueName}" class="fw-semibold mb-0">Athens Open Theatre</span>
                    </div>
                    <div class="d-flex align-items-center text-muted ms-4 mb-2 two-column-span">
                        <span th:text="${occurrenceCard.venueStreet} + ' ' + ${occurrenceCard.venueNumber} +
                                        ' ' + ${occurrenceCard.venueCity} + ' ' + ${occurrenceCard.venueZipcode()}"
                              class="mb-0">Aiolou 69, Athens 64100</span>
                    </div>
                </div>
                <div class="availability-badge">
                    <span class="badge rounded-pill"
                          th:text="${occurrenceCard.availabilityLevel.label}"
                          th:classappend="${occurrenceCard.availabilityLevel.badge}">
                        Available
                    </span>
                </div>
                <div class="booking-price">
                    <p th:text="${occurrenceCard.price} + '€'" class="mb-0 fw-bold">From 89€</p>
                    <p class="text-muted">per ticket</p>
                </div>
                <div class="cta-tickets">
                    <button class="btn btn-lg btn-dark"
                            th:data-event="${eventCard.eventTitle}"
                            th:data-datetime="${#temporals.format(occurrenceCard.dateTime,
                                              'EEEE, MMM d, yyyy • h:mm a')}"
                            th:data-venue="${occurrenceCard.venueName}"
                            th:data-price="${occurrenceCard.price}"
                            th:data-occ-id="${occurrenceCard.occurrenceId}"
                            data-open="tickets"
                            th:disabled="${occurrenceCard.availabilityLevel ==
                            T(com.unipi.gsimos.vistaseat.dto.EventOccurrenceCardDto.AvailabilityLevel).SOLD_OUT}">
                        <i class="bi bi-ticket-perforated me-2"></i>
                        Tickets
                    </button>
                </div>
            </div>
        </div>

    </section>

    <div th:insert="~{fragments/footer :: footer}"></div>

    <div th:replace="~{fragments/tickets-modal :: ticketsModal}"></div>

    <script th:src="@{/js/main-app.js}"></script>

    <script>
        // tickets-modal.js
        document.addEventListener('DOMContentLoaded', () => {
            const modal      = new bootstrap.Modal(document.getElementById('ticketsModal'));

            // Events details
            const nameEl     = document.getElementById('modalEventName');
            const dateEl     = document.getElementById('modalDateTime');
            const venueEl    = document.getElementById('modalVenue');

            // Ticket selector controls
            const minusBtn   = document.getElementById('minusBtn');
            const plusBtn    = document.getElementById('plusBtn');
            const countEl    = document.getElementById('ticketCount');

            // Cost displays
            const maxInfoEl     = document.getElementById('maxTicketsPerOrder');
            const countTicketsEl= document.getElementById('countTickets');
            const ticketsTotalEl= document.getElementById('ticketsTotal');
            const serviceFeeEl  = document.getElementById('serviceFeeAmount');
            const totalAmountEl = document.getElementById('totalAmount');

            const reserveBtn = document.getElementById('reserveBtn');

            const MAX_TICKETS = 10; // max number of tickets per reservation
            const SERVICE_FEE = 0.10; // service fee per ticket

            let count = 1;
            let unitPrice = 0;

            // Calculate and display costs on the modal
            function renderCosts() {
                const ticketsCost = unitPrice * count;
                const serviceFeeAmount = SERVICE_FEE * count;
                const totalAmount = ticketsCost + serviceFeeAmount;

                countTicketsEl.textContent = `Tickets (${count}×)`;
                ticketsTotalEl.textContent = ticketsCost + ' €';
                serviceFeeEl.textContent = serviceFeeAmount.toFixed(2) + ' €';
                totalAmountEl.textContent = totalAmount + ' €';
            }

            function setCount(n) {
                count = Math.min(Math.max(n, 1), MAX_TICKETS); // forces the requested number n to stay inside the legal range
                countEl.textContent = count;
                minusBtn.disabled = count <= 1;
                plusBtn.disabled  = count >= MAX_TICKETS;
                renderCosts();
            }

            minusBtn.addEventListener('click', () => setCount(count - 1));
            plusBtn .addEventListener('click', () => setCount(count + 1));

            // Open modal every time the tickets button is clicked
            document.querySelectorAll('[data-open="tickets"]').forEach(btn => {
                btn.addEventListener('click', () => {

                    // Set unitPrice to data-price, if that can’t be parsed, default to 0.
                    unitPrice = parseFloat(btn.dataset.price) || 0;

                    // populate modal content
                    nameEl.textContent  = btn.dataset.event;
                    dateEl.textContent  = btn.dataset.datetime;
                    venueEl.textContent = btn.dataset.venue;
                    maxInfoEl.textContent = `Maximum ${MAX_TICKETS} tickets per order`;
                    reserveBtn.dataset.occId = btn.dataset.occId;  // stash the ID

                    setCount(1);
                    modal.show();
                });
            });

            reserveBtn.addEventListener('click', () => {

                const form = document.createElement('form');
                form.method = 'GET';
                form.action = "/api/makeBooking";

                [
                    ['occurrenceId', reserveBtn.dataset.occId],
                    ['requestedTickets',       count]
                ].forEach(([name, value]) => {
                    const inp = document.createElement('input');
                    inp.type  = 'hidden';
                    inp.name  = name;
                    inp.value = value;
                    form.appendChild(inp);
                });

                document.body.appendChild(form);
                form.submit();
            });
        });
    </script>

    <script>
        // Function to fade out and remove alerts for seat unavailability.
        // If the success alert is on the page, wait 5 seconds,
        // then fade it out over 1 second, and finally remove it completely
        function autoDismissAlert(element, delay = 5000, fadeDuration = 1000) {
            if (element) {
                setTimeout(() => {
                    element.style.transition = `opacity ${fadeDuration}ms`;
                    element.style.opacity = 0;
                    setTimeout(() => element.remove(), fadeDuration);
                }, delay);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const successAlert = document.getElementById('success-alert');
            const accessDeniedAlert = document.getElementById('access-denied-alert');
            autoDismissAlert(successAlert);
            autoDismissAlert(accessDeniedAlert);
        });

    </script>
</body>
</html>