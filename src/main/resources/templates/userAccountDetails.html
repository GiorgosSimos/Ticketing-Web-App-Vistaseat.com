<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>User Account Details</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body class="user-account-bg-style">

    <div th:insert="~{fragments/header :: header}"></div>

    <div class="user-account-settings-layout">
        <!-- Include Sidebar-->
        <div th:replace="~{fragments/userAccountSidebar :: userAccountSidebar('userAccountDetails')}"></div>

        <section class="user-account-settings-section">
            <!--Update alert messages-->
            <div th:if="${message}" class="alert alert-success" id="success-alert" role="alert" th:text="${message}"></div>
            <div th:if="${error}" class="alert alert-danger" id="error-alert" role="alert" th:text="${error}"></div>

            <!--Account Settings Card-->
            <div class="user-account-container">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-person-vcard fs-3 me-2"></i>
                    <h2 class="mb-0">Account Details</h2>
                </div>
                <p class="text-muted mb-4">Modify the information of your account.
                    Your <strong>email address</strong> is your unique account identifier and <strong>cannot be modified</strong>.
                </p>
                <form id="userAccountForm" th:action="@{/userAccount/update}" method="post">
                    <div class="user-account-grid">
                        <div class="grid-item">First Name:</div>
                        <div class="grid-item">
                            <input type="text" id="firstName" name="firstName" th:value="${firstName}" readonly>
                        </div>
                        <div class="grid-item">Last Name:</div>
                        <div class="grid-item">
                            <input type="text" id="lastName" name="lastName" th:value="${lastName}" readonly>
                        </div>
                        <div class="grid-item">Email:</div>
                        <div class="grid-item">
                            <input type="email" id="email" name="email"
                                   class="permanently-disabled" th:value="${email}" disabled>
                        </div>
                        <div class="grid-item">Phone:</div>
                        <div class="grid-item">
                            <input type="text" id="phone" name="phone" th:value="${phone}" readonly>
                        </div>
                    </div>
                    <button type="button" id="editBtn"
                            class="btn btn-primary w-100 rounded-pill mt-3 full-span"
                            data-mode="view">
                        Edit
                    </button>
                </form>
            </div>
        </section>
    </div>

    <div th:insert="~{fragments/footer :: footer}"></div>

    <!-- Edit - Save button -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const editBtn = document.getElementById("editBtn");
            const form = document.getElementById("userAccountForm");
            const inputs = form.querySelectorAll(".user-account-grid input:not(.permanently-disabled)");

            // Prevent any submit while in view mode
            form.addEventListener("submit", function (e) {
                const mode = editBtn.dataset.mode || "view";
                console.log("[userAccountForm] submit fired, mode =", mode);
                if (mode === "view") {
                    e.preventDefault();
                    console.warn("[userAccountForm] blocked submit in view mode");
                }
            });

            // Toggle between "Edit" and "Save" buttons
            editBtn.addEventListener("click", function () {
                const mode = editBtn.dataset.mode || "view";
                console.log("[editBtn] click, current mode =", mode);

                if (mode === "view") {
                    // switch to edit mode
                    inputs.forEach(input => {
                        input.readOnly = false;
                        input.style.background = "#fff";
                    });
                    editBtn.textContent = "Save";
                    editBtn.classList.remove("btn-primary");
                    editBtn.classList.add("btn-success");
                    editBtn.dataset.mode = "edit";
                    console.log("[editBtn] switched to edit mode");
                } else {
                    // switch back to view mode by submitting
                    console.log("[editBtn] submitting form");
                    form.submit();
                }
            });
        });
    </script>

    <script th:src="@{/js/main-app.js}"></script>
</body>
</html>