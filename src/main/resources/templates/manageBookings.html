<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Bookings | Vistaseat.com</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" th:href="@{/css/adminStyle.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script th:src="@{/js/admin.js}" defer></script>
</head>
<body>
    <!-- Include Header-->
    <div th:replace="fragments/adminHeader :: adminHeader(${firstName}, ${lastName})"></div>

    <div class="manage-bookings-layout">
        <!-- Include Admin Sidebar-->
        <div th:replace="fragments/adminSidebar :: adminSidebar ('manageBookings')"></div>
        <!-- Section Booking Info -->
        <section id="manageBookings">
            <!-- Alert messages for changes made -->
            <div th:if="${message}" class="alert alert-success" id="success-alert" th:text="${message}"></div>
            <div th:if="${error}" class="alert alert-danger" id="access-denied-alert" th:text="${error} "></div>

            <div class="manage-booking-container mt-5">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-card-checklist fs-2 me-2"></i>
                    <h2 class="mb-0">Manage Bookings</h2>
                </div>

                <div class="advanced-search-container">
                    <!-- Advanced Search Form -->
                    <form th:action="@{/adminDashboard/manageBookings}"
                          method="get"
                          class="search-bookings-bar">
                        <!-- Left: Search Input Field -->
                        <div class="search-bookings-input-field input-group w-100">
                            <input type="text"
                                   class="form-control"
                                   placeholder="Search Bookings by..."
                                   name="searchQuery"
                                   title="Search"
                                   th:value="${param.searchQuery}">

                            <!-- Search button -->
                            <button class="btn btn-outline-secondary"
                                    type="submit"
                                    title="Search">
                                <i class="bi bi-search"></i>
                            </button>

                            <!-- Clear button (only shown if searchQuery exists) -->
                            <button class="btn btn-outline-danger" type="button" title="Clear"
                                    th:unless="${#strings.isEmpty(param.searchQuery)}"
                                    onclick="
                                        const f = this.form;
                                        f.querySelector('[name=searchQuery]').value='';
                                        f.querySelector('[name=searchField]').value='BOOKING_ID';
                                        f.submit();">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>

                        <!-- Search Criteria -->
                        <div class="search-criteria-field">
                            <select class="form-select " name="searchField" title="Search Criteria"
                                    th:with="sel=${#lists.isEmpty(param.searchField) ? 'BOOKING_ID' : param.searchField[0]}">
                                <option value="BOOKING_ID"     th:selected="${sel == 'BOOKING_ID'}">ID</option>
                                <option value="EVENT_NAME"     th:selected="${sel == 'EVENT_NAME'}">Event</option>
                                <option value="CUSTOMER_EMAIL" th:selected="${sel == 'CUSTOMER_EMAIL'}">Customer email</option>
                                <option value="VENUE_NAME"     th:selected="${sel == 'VENUE_NAME'}">Venue</option>
                            </select>
                        </div>

                    </form>

                    <div class="bookings-range-picker">
                        <!-- Search by date range Picker -->
                        <form th:action="@{/adminDashboard/manageBookings}"
                              method="get"
                              id="dateForm">
                            <!-- Visible range picker -->
                            <div class="col-auto form-floating position-relative">
                                <input id="rangePicker"
                                       type="text"
                                       class="form-control"
                                       placeholder="From... to..."
                                       th:attr="data-from=${from}, data-to=${to}">
                                <label for="rangePicker">Filter By Date</label>
                            </div>
                            <!-- Hidden fields actually sent to the server -->
                            <input type="hidden" name="from" id="fromHidden" th:value="${from}">
                            <input type="hidden" name="to"   id="toHidden"   th:value="${to}">
                        </form>
                        <!-- Clear All filters -->
                        <button class="btn btn-outline-dark"
                                type="button" id="clearFilterBtn">
                            Clear Filters
                        </button>
                    </div>
                </div>

                <hr>

                <!-- Display Message when no bookings are found -->
                <div th:if="${totalPages == 0}"
                     class="empty-state d-flex flex-column justify-content-center align-items-center text-center">
                    <i class="bi bi-receipt-cutoff fs-1 mb-3"></i>
                    <h3 class="fw-semibold mb-1">No bookings found</h3>
                </div>

                <!-- Bookings Table -->
                <div th:if="${totalPages > 0}"
                        class="table-responsive">
                    <div class="rounded-3 overflow-hidden shadow">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-secondary">
                            <tr class="text-nowrap">
                                <th>ID</th>
                                <th>Event</th>
                                <th>Venue</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Booked On</th>
                                <th>Tickets</th>
                                <th>Amount (€)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="booking : ${bookingsList}">
                                <td th:text="${booking.id}">123</td>
                                <td th:text="${booking.eventName}"></td>
                                <td th:text="${booking.eventVenueName}"></td>
                                <td th:text="${#temporals.format(booking.occurrenceDate, 'dd-MM-yyyy - h:mm a')}">13-09-2025 • 1:20 PM</td>
                                <td>
                                    <span th:text="${booking.firstName + ' ' + booking.lastName}"></span><br>
                                    <span th:text="${booking.email}"></span>
                                </td>
                                <td th:text="${#temporals.format(booking.bookingDate, 'dd-MM-yyyy - h:mm a')}">13-09-2025 • 1:20 PM</td>
                                <td th:text="${booking.numberOfTickets}"></td>
                                <td th:text="${booking.totalAmount}"></td>
                                <td th:text="${booking.status}">Confirmed</td>
                                <td class="text-nowrap">
                                    <!-- Button: View Booking details -->
                                    <form th:action="@{'/adminDashboard/manageBookings/viewBooking/'+ ${booking.id}}"
                                          method="get"
                                          class="confirm-form-submission"
                                          data-message="View booking details?"
                                          style="display: inline;">
                                        <button class="btn btn-sm btn-primary me-1"
                                                id="btn-view-booking-details"
                                                title="View Booking details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </form>
                                    <!-- Delete Booking Button -->
                                    <form th:action="@{'/adminDashboard/manageBookings/delete/' + ${booking.id}}"
                                          method="post"
                                          class="confirm-form-submission"
                                          data-message="Are you sure you want to delete this booking?"
                                          style="display: inline;">
                                        <button class="btn btn-sm btn-danger" id="btn-delete-booking"
                                                title="Delete Booking" type="submit">
                                            <i class="bi bi-trash3-fill"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                </div>

                <!-- Pagination Controls -->
                <div th:if="${totalPages > 0}"
                        class="d-flex justify-content-end align-items-center my-3">
                    <!-- First Page - Go to first page (index 0)-->
                    <button class="btn btn-sm btn btn-light me-1"
                            th:disabled="${currentPage == 1}"
                            onclick="goToPage(0)">
                        First Page
                    </button>
                    <!-- Previous Page - Go to page before current-->
                    <button class="btn btn-sm btn btn-light me-2"
                            th:disabled="${currentPage == 1}"
                            th:onclick="'goToPage(' + (${currentPage} - 2) + ')'">
                        <i class="bi bi-caret-left"></i>
                    </button>

                    <!-- Page Info -->
                    <span class="me-2">Page <span th:text="${currentPage}">1</span> of <span th:text="${totalPages}">2</span></span>

                    <!-- Next Page -->
                    <button class="btn btn-sm btn btn-light me-1"
                            th:disabled="${currentPage == totalPages}"
                            th:onclick="'goToPage(' + ${currentPage} + ')'">
                        <i class="bi bi-caret-right"></i>
                    </button>

                    <!-- Last Page -->
                    <button class="btn btn-sm btn btn-light"
                            th:disabled="${currentPage == totalPages}"
                            th:onclick="'goToPage(' + (${totalPages} - 1) + ')'">
                        Last Page
                    </button>
                </div>

            </div>
        </section>
    </div>

    <!-- Bootstrap modal for confirm dialogues-->
    <div th:replace="~{fragments/confirmModal :: confirmModalFragment}"></div>

    <!-- Include Footer-->
    <div th:replace="fragments/adminFooter :: footer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Reference to the "Clear Filter" button
            const clearFilterBtn = document.getElementById("clearFilterBtn");

            // References to form and input elements
            const form       = document.getElementById('dateForm');
            const input      = document.getElementById('rangePicker');
            const fromHidden = document.getElementById('fromHidden');
            const toHidden   = document.getElementById('toHidden');

            // Prevents multiple form submissions
            let alreadySubmitting = false;

            // Initialize Flatpickr on the range picker input
            flatpickr(input, {
                mode: "range", // Enable date range selection
                dateFormat: "Y-m-d", // Format to match backend expectations
                defaultDate: [input.dataset.from, input.dataset.to].filter(Boolean), // Preload selected range, if available
                onChange(selectedDates, _dateStr, fp) {
                    if (selectedDates.length === 2) {
                        const [from, to] = selectedDates;

                        // Set hidden fields without converting to UTC
                        fromHidden.value = fp.formatDate(from, "Y-m-d");
                        toHidden.value   = fp.formatDate(to,   "Y-m-d");

                        // Submit the form only once after full selection
                        if (!alreadySubmitting) {
                            alreadySubmitting = true;
                            form.requestSubmit?.() ?? form.submit(); // Use requestSubmit if supported
                        }
                    } else {
                        // Clear hidden fields if range is incomplete
                        fromHidden.value = "";
                        toHidden.value   = "";
                    }
                }
            });

            // Add click listener to "Clear Filter" button (if it exists)
            if (clearFilterBtn) {
                clearFilterBtn.addEventListener("click", function() {
                    // Get the base URL (without query parameters)
                    const baseUrl = window.location.origin + window.location.pathname + "#manageBookings";
                    // Redirect to the base URL, effectively clearing filters
                    window.location.href = baseUrl;
                });
            }
        });

    </script>

    <script>
        // function for pagination controls
        function goToPage(pageNumber) {
            const url = new URL(window.location.href);
            url.searchParams.set("page", pageNumber);

            // Grabs current search filters from the DOM
            const searchQuery = document.querySelector('input[name="searchQuery"]')?.value;
            if (searchQuery) url.searchParams.set("searchQuery", searchQuery);

            window.location.href = url.toString();
        }
    </script>
</body>
</html>