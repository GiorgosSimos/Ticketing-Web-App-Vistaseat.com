<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Event Occurrences | Vistaseat.com</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/adminStyle.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin.js}" defer></script>
</head>
<body>

    <!-- Include Header -->
    <div th:insert="~{fragments/adminHeader :: adminHeader(${firstName}, ${lastName})}"></div>

    <!-- Alert messages for changes made -->
    <div th:if="${message}" class="alert alert-success" id="success-alert" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" id="access-denied-alert" th:text="${error} "></div>


    <!-- Section Event Details - Add Occurrence Button -->
    <section class="eventOccurrences-head border-2 shadow-sm p-3 mt-4 mb-4">

        <!-- Gap Between Items (3%) -->
        <div class="d-flex flex-row flex-wrap align-items-start gap-3">

            <!-- Event Image (20%) -->
            <figure class="event-img flex-shrink-0" th:switch="${event.eventType}">
                <!-- CINEMA -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).CINEMA}"
                     th:src="@{/images/feature_film.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Feature Film">

                <!-- THEATER -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).THEATER}"
                     th:src="@{/images/theater_play.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Theater event">

                <!-- SPORT -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).SPORTS}"
                     th:src="@{/images/sports.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Sport event">

                <!-- CONCERT -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).CONCERT}"
                     th:src="@{/images/music_concert.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Concert event">

                <!-- MUSEUM -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).MUSEUM}"
                     th:src="@{/images/museum_visit.png}"
                     class="img-fluid rounded-2 w-100"
                     alt="Museum visit">

                <!-- ARCHAEOLOGICAL -->
                <img th:case="${T(com.unipi.gsimos.vistaseat.model.EventType).ARCHAEOLOGICAL}"
                     th:src="@{/images/archaeological_site.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Archaeological Site visit">

                <!-- default / fallback -->
                <img th:case="*"
                     th:src="@{/images/events_generic.jpg}"
                     class="img-fluid rounded-2 w-100"
                     alt="Event image">

            </figure>

            <!-- Event Info (55%) -->
            <article class="event-info">
                <h2 class="fw-semibold mb-2" th:text="${event.name}">Event Name</h2>
                <span class="badge rounded-pill text-bg-dark mb-2">
            <span class="text-bg-dark" th:text="${event.eventType}"></span>
          </span>
                <div class="d-flex align-items-center mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="bi bi-geo-alt me-1" viewBox="0 0 16 16">
                        <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A32 32 0 0 1 8 14.58a32 32 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10"/>
                        <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4m0 1a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                    </svg>
                    <a th:href="@{'/adminDashboard/manageVenues/eventsForVenue/' +${event.venueId} }"
                       class="mb-1 text-decoration-none text-dark"
                       th:text="${event.venueName}">
                        Madison Square Garden
                    </a>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-clock me-2"></i>
                    <span th:text="${#temporals.format(occurrence.eventDateTime, 'EEEE dd-MM-yyyy - h:mm a')}"></span>
                </div>
                <strong>Description: </strong><span class="mt-2 mb-0 small text-muted" th:text="${event.description}">
            Event Description</span>
            </article>
        </div>
    </section>

    <!-- Section Occurrence Bookings Info -->
    <section class="container mt-4">

        <!-- Search Bookings filter -->
        <div class="advanced-search-container mb-4">
            <!-- Advanced Search Form -->
            <form th:action="@{'/adminDashboard/manageBookingsOfOccurrence/' + ${occurrence.id} }"
                  method="get"
                  class="search-occurrence-bookings-bar">
                <!-- Left: Search Input Field -->
                <div class="search-occurrence-bookings-input-field input-group">
                    <input type="text"
                           class="form-control"
                           placeholder="Search Bookings by..."
                           name="searchQuery"
                           title="Search"
                           th:value="${param.searchQuery}">

                    <!-- Search button -->
                    <button class="btn btn-outline-secondary"
                            type="submit"
                            title="Search">
                        <i class="bi bi-search"></i>
                    </button>

                    <!-- Clear button (only shown if searchQuery exists) -->
                    <button class="btn btn-outline-danger" type="button" title="Clear"
                            th:unless="${#strings.isEmpty(param.searchQuery)}"
                            onclick="
                                        const f = this.form;
                                        f.querySelector('[name=searchQuery]').value='';
                                        f.querySelector('[name=searchField]').value='BOOKING_ID';
                                        f.submit();">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <!-- Search Criteria -->
                <div class="search-criteria-field">
                    <select class="form-select " name="searchField" title="Search Criteria"
                            th:with="sel=${#lists.isEmpty(param.searchField) ? 'BOOKING_ID' : param.searchField[0]}">
                        <option value="BOOKING_ID"     th:selected="${sel == 'BOOKING_ID'}">ID</option>
                        <option value="CUSTOMER_NAME" th:selected="${sel == 'CUSTOMER_NAME'}">Customer name</option>
                    </select>
                </div>
            </form>
        </div>


        <!-- Display Message when no bookings are found -->
        <div th:if="${totalPages == 0}"
             class="empty-state d-flex flex-column justify-content-center align-items-center text-center">
            <i class="bi bi-receipt-cutoff fs-1 mb-3"></i>
            <h3 class="fw-semibold mb-1">No bookings found</h3>
        </div>

        <!-- Bookings Table -->
        <div th:if="${totalPages > 0}"
             class="table-responsive">
            <div class="d-flex align-items-center mb-4">
                <i class="bi bi-receipt-cutoff fs-4 me-2"></i>
                <span>Occurrence Bookings</span>
            </div>

            <div class="rounded-3 overflow-hidden shadow">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-secondary">
                    <tr class="text-nowrap">
                        <th>ID</th>
                        <th>Event</th>
                        <th>Venue</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Booked On</th>
                        <th>Tickets</th>
                        <th>Amount (€)</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="booking : ${bookingsList}">
                        <td th:text="${booking.id}">123</td>
                        <td th:text="${booking.eventName}"></td>
                        <td th:text="${booking.eventVenueName}"></td>
                        <td th:text="${#temporals.format(booking.occurrenceDate, 'dd-MM-yyyy - h:mm a')}">13-09-2025 • 1:20 PM</td>
                        <td>
                            <span th:text="${booking.firstName + ' ' + booking.lastName}"></span><br>
                            <span th:text="${booking.email}"></span>
                        </td>
                        <td th:text="${#temporals.format(booking.bookingDate, 'dd-MM-yyyy - h:mm a')}">13-09-2025 • 1:20 PM</td>
                        <td th:text="${booking.numberOfTickets}"></td>
                        <td th:text="${booking.totalAmount}"></td>
                        <td th:text="${booking.status}">Confirmed</td>
                        <td class="text-nowrap">
                            <!-- Button: View Booking details -->
                            <form th:action="@{'/adminDashboard/manageBookings/viewBooking/'+ ${booking.id}}"
                                  method="get"
                                  class="confirm-form-submission"
                                  data-message="View booking details?"
                                  style="display: inline;">
                                <button class="btn btn-sm btn-primary me-1"
                                        id="btn-view-booking-details"
                                        title="View Booking details">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </form>
                            <!-- Delete Booking Button -->
                            <form th:action="@{'/adminDashboard/manageBookings/delete/' + ${booking.id}}"
                                  method="post"
                                  class="confirm-form-submission"
                                  data-message="Are you sure you want to delete this booking?"
                                  style="display: inline;">
                                <button class="btn btn-sm btn-danger" id="btn-delete-booking"
                                        title="Delete Booking" type="submit">
                                    <i class="bi bi-trash3-fill"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
        <!-- Pagination Controls -->
        <div th:if="${totalPages > 0}"
             class="d-flex justify-content-end align-items-center my-3">
            <!-- First Page - Go to first page (index 0)-->
            <button class="btn btn-sm btn btn-light me-1"
                    th:disabled="${currentPage == 1}"
                    onclick="goToPage(0)">
                First Page
            </button>
            <!-- Previous Page - Go to page before current-->
            <button class="btn btn-sm btn btn-light me-2"
                    th:disabled="${currentPage == 1}"
                    th:onclick="'goToPage(' + (${currentPage} - 2) + ')'">
                <i class="bi bi-caret-left"></i>
            </button>

            <!-- Page Info -->
            <span class="me-2">Page <span th:text="${currentPage}">1</span> of <span th:text="${totalPages}">2</span></span>

            <!-- Next Page -->
            <button class="btn btn-sm btn btn-light me-1"
                    th:disabled="${currentPage == totalPages}"
                    th:onclick="'goToPage(' + ${currentPage} + ')'">
                <i class="bi bi-caret-right"></i>
            </button>

            <!-- Last Page -->
            <button class="btn btn-sm btn btn-light"
                    th:disabled="${currentPage == totalPages}"
                    th:onclick="'goToPage(' + (${totalPages} - 1) + ')'">
                Last Page
            </button>
        </div>
        <hr>
    </section>

    <!-- Section Occurrence Bookings Cards -->
    <section class="eventOccurrence-cards">
        <div class="eventOccurrence-card">
            <div class="d-flex align-items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi bi-calendar2-week me-2" viewBox="0 0 16 16">
                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M2 2a1 1 0 0 0-1 1v11a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"/>
                    <path d="M2.5 4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H3a.5.5 0 0 1-.5-.5zM11 7.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm-5 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5z"/>
                </svg>
                <span>Total Bookings</span>
            </div>
            <span th:text="${numberOfTotalBookings}">4</span>
        </div>
        <div class="eventOccurrence-card">
            <div class="d-flex align-items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi bi-people-fill me-2" viewBox="0 0 16 16">
                    <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
                </svg>
                <span>Confirmed Tickets</span>
            </div>
            <span th:text="${occurrenceTotalTickets}">120</span>
        </div>
        <div class="eventOccurrence-card">
            <div class="d-flex align-items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" class="bi bi-cash-stack me-2" viewBox="0 0 16 16">
                    <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                    <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2z"/>
                </svg>
                <span>Revenue From Occurrence</span>
            </div>
            <span th:text="${occurrence.getOccurrenceTotalRevenue} + ' €'">109,500</span>
        </div>
    </section>

    <!-- Bootstrap modal to confirm dialogues-->
    <div th:replace="~{fragments/confirmModal :: confirmModalFragment}"></div>

    <!-- Include Footer-->
    <div th:insert="~{fragments/adminFooter :: footer}"></div>

    <script>
        // function for pagination controls
        function goToPage(pageNumber) {
            const url = new URL(window.location.href);
            url.searchParams.set("page", pageNumber);

            // Grabs current search filters from the DOM
            const searchQuery = document.querySelector('input[name="searchQuery"]')?.value;
            if (searchQuery) url.searchParams.set("searchQuery", searchQuery);

            window.location.href = url.toString();
        }
    </script>

</body>
</html>