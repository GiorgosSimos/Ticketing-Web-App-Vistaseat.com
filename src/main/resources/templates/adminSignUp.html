<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Vistaseat.com | Admin Sign Up</title>
    <link rel="icon" type="image/png" sizes="16x16" th:href="@{/images/favicon.png}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/adminLoginSignUpStyle.css}">
    <script th:src="@{/js/signInSignUp.js}" async></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@6.0.4/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@6.0.4/dist/ionicons/ionicons.js"></script>
</head>
<body>

    <h1 class="fw-bold">Welcome to vistaseat.com</h1>
    <section>
        <form action="/api/admin/register" method="POST">
            <h2>New Admin Account</h2>

            <div class="inputbox">
                <ion-icon name="body-outline"></ion-icon>
                <input type="text"
                       id="firstName"
                       name="firstName"
                       pattern="^[A-Za-zÀ-ÖØ-öø-ÿ]{2,30}(?:[ '--][A-Za-zÀ-ÖØ-öø-ÿ]{2,30})?$"
                       title="Only letters, optional apostrophe or hyphen (e.g. Jean-Luc)"
                       required>
                <label for="firstName">First Name</label>
            </div>
            <div class="inputbox">
                <ion-icon name="body-outline"></ion-icon>
                <input type="text"
                       id="lastName"
                       name="lastName"
                       pattern="^[A-Za-zÀ-ÖØ-öø-ÿ]{2,40}(?:[ '--][A-Za-zÀ-ÖØ-öø-ÿ]{2,40})*$"
                       title="Only letters, spaces, apostrophes, hyphens allowed (e.g. van der Mer)"
                       required>
                <label for="lastName">Last Name</label>
            </div>
            <div class="inputbox">
                <ion-icon name="call-outline"></ion-icon>
                <input type="tel"
                       id="phone"
                       name="phone"
                       pattern="^\+?[0-9. ()-]{7,20}$"
                       maxlength="20"
                       title="Use digits, space, -, (), or +"
                       required>
                <label for="phone">Phone</label>
            </div>
            <div class="inputbox">
                <ion-icon name="mail-outline"></ion-icon>
                <input type="email"
                       id="email"
                       name="email"
                       title="example@domain.com"
                       required>
                <label for="email">Your email</label>
            </div>
            <div class="inputbox">
                <ion-icon name="people-outline"></ion-icon>
                <select id="role" name="role" required>
                    <option value="" disabled selected>Admin Role</option>
                    <th:block th:each="role : ${userRoles}">
                        <option th:unless="${role == REGISTERED}"
                                th:value="${role}"
                                th:text="${role.displayRole}">
                            Admin Role
                        </option>
                    </th:block>
                </select>

                <!-- floating label, same as inputs -->
                <label for="role">Admin Role</label>
            </div>
            <div class="inputbox password-box">
                <input type="password"
                       id="password"
                       name="password"
                       minlength="8"
                       pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$_])[A-Za-z\d!@#$_]{8,}$"
                       title="At least 8 chars, include 1 lowercase, 1 uppercase, 1 number, and 1 special: !, @, #, $, _."
                       required>
                <label for="password">Your password</label>
                <ion-icon name="eye-off-outline" class="toggle-password" onclick="togglePassword('password', this)"></ion-icon>
            </div>
            <div class="inputbox password-box">
                <input type="password" id="confirmPassword" name="confirmPassword" minlength="8" required>
                <label for="confirmPassword">Confirm password</label>
                <ion-icon name="eye-off-outline" class="toggle-password" onclick="togglePassword('confirmPassword', this)"></ion-icon>
            </div>
            <button type="submit">Create</button>
        </form>
    </section>

    <!-- Sign-up success modal -->
    <div class="modal fade" id="signupSuccessModal" tabindex="-1" aria-labelledby="signupSuccessLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="signupSuccessLabel">Registration Successful</h5>
                </div>
                <div class="modal-body">
                    <p id="signupSuccessMessage" class="mb-0">
                        Your account has been created successfully.
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" id="modalOkBtn" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password Regex:
        // - (?=.*[a-z])  at least one lowercase
        // - (?=.*[A-Z])  at least one uppercase
        // - (?=.*\d)     at least one digit
        // - (?=.*[!@#$_]) at least one of the allowed specials
        // - [A-Za-z\d!@#$_]{8,} only allow letters/digits/these specials, min 8 chars
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$_])[A-Za-z\d!@#$_]{8,}$/;
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');

        password.addEventListener('input', function() {
            this.setCustomValidity(
                passwordRegex.test(this.value)
                ? ''
                : 'Password must be at least 8 characters and include: 1 lowercase, 1 uppercase, 1 number, and one of ! @ # $ _.'
            );
        });

        confirmPassword.addEventListener('input', function() {
            this.setCustomValidity(this.value && this.value !== password.value ? 'Passwords do not match' : '');
        });

        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission

            const formData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value,
                password: password.value
            };

            try {
                const response = await fetch('/api/admin/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const msgEl = document.getElementById('signupSuccessMessage');
                    msgEl.textContent = `Welcome, ${formData.firstName}! Your admin account has been created successfully.`;

                    // Show Bootstrap modal (v5)
                    const modalEl = document.getElementById('signupSuccessModal');
                    if (window.bootstrap?.Modal) {
                        const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
                        modal.show();

                        // Redirect only when user clicks OK
                        const okBtn = document.getElementById('modalOkBtn');
                        // Ensure we don't add multiple listeners on repeated submissions
                        okBtn.onclick = () => {
                            // Optionally hide the modal first
                            modal.hide();
                            window.location.href = '/adminLogin';
                        };

                    } else {
                        // Fallback if Bootstrap isn't loaded
                        alert('User has registered successfully');
                        window.location.href = '/adminLogin';
                    }
                } else {
                    // Read once as text, then try JSON.parse
                    const raw = await response.text();
                    let msg = "An unexpected error occurred";
                    try {
                        const data = JSON.parse(raw);
                        msg = data.message || msg;
                    } catch {
                        console.warn("Non-JSON error body:", raw);
                    }
                    alert("Registration failed: " + msg);
                }
            } catch (error) {
                alert("An error occurred: " + error.message);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>