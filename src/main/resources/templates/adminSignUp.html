<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Vistaseat.com | Admin Sign Up</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/css/adminLoginSignUpStyle.css}">
    <script th:src="@{/js/signInSignUp.js}" async></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@6.0.4/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons@6.0.4/dist/ionicons/ionicons.js"></script>
</head>
<body>

    <h1 class="fw-bold">Welcome to vistaseat.com</h1>
    <section>
        <form action="/api/admin/register" method="POST">
            <h2>New Admin Account</h2>

            <div class="inputbox">
                <ion-icon name="body-outline"></ion-icon>
                <input type="text" id="firstName" name="firstName" required>
                <label for="firstName">First Name</label>
            </div>
            <div class="inputbox">
                <ion-icon name="body-outline"></ion-icon>
                <input type="text" id="lastName" name="lastName" required>
                <label for="lastName">Last Name</label>
            </div>
            <div class="inputbox">
                <ion-icon name="call-outline"></ion-icon>
                <input type="tel" id="phone" name="phone" required>
                <label for="phone">Phone</label>
            </div>
            <div class="inputbox">
                <ion-icon name="mail-outline"></ion-icon>
                <input type="email" id="email" name="email" required>
                <label for="email">Your email</label>
            </div>
            <div class="inputbox">
                <ion-icon name="people-outline"></ion-icon>
                <select id="role" name="role" required>
                    <option value="" disabled selected>Admin Role</option>
                    <th:block th:each="role : ${userRoles}">
                        <option th:unless="${role == REGISTERED}"
                                th:value="${role}"
                                th:text="${role.displayRole}">
                            Admin Role
                        </option>
                    </th:block>
                </select>

                <!-- floating label, same as inputs -->
                <label for="role">Admin Role</label>
            </div>
            <div class="inputbox password-box">
                <input type="password" id="password" name="password" minlength="8" required>
                <label for="password">Your password</label>
                <ion-icon name="eye-off-outline" class="toggle-password" onclick="togglePassword('password', this)"></ion-icon>
            </div>
            <div class="inputbox password-box">
                <input type="password" id="confirmPassword" name="confirmPassword" minlength="8" required>
                <label for="confirmPassword">Confirm password</label>
                <ion-icon name="eye-off-outline" class="toggle-password" onclick="togglePassword('confirmPassword', this)"></ion-icon>
            </div>
            <button type="submit">Create</button>
        </form>
    </section>

    <!-- Sign-up success modal -->
    <div class="modal fade" id="signupSuccessModal" tabindex="-1" aria-labelledby="signupSuccessLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="signupSuccessLabel">Registration Successful</h5>
                </div>
                <div class="modal-body">
                    <p id="signupSuccessMessage" class="mb-0">
                        Your account has been created successfully.
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" id="modalOkBtn" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault(); // Prevent default form submission

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (password!==confirmPassword) {
                alert('Passwords do not match.');
                return;
            }

            const formData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value,
                password: password
            };

            try {
                const response = await fetch('/api/admin/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const msgEl = document.getElementById('signupSuccessMessage');
                    msgEl.textContent = `Welcome, ${formData.firstName}! Your admin account has been created successfully.`;

                    // Show Bootstrap modal (v5)
                    const modalEl = document.getElementById('signupSuccessModal');
                    if (window.bootstrap?.Modal) {
                        const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
                        modal.show();

                        // Redirect only when user clicks OK
                        const okBtn = document.getElementById('modalOkBtn');
                        // Ensure we don't add multiple listeners on repeated submissions
                        okBtn.onclick = () => {
                            // Optionally hide the modal first
                            modal.hide();
                            window.location.href = '/adminLogin';
                        };

                    } else {
                        // Fallback if Bootstrap isn't loaded
                        alert('User has registered successfully');
                        window.location.href = '/adminLogin';
                    }
                } else {
                    try {
                        const errorData = await response.json();
                        alert("Registration failed: " + (errorData.message || "An unexpected error occurred"));
                    } catch (parseError) {
                        const rawText = await response.text(); // fallback
                        console.warn("Could not parse JSON. Raw response:", rawText);
                        alert("Registration failed. Server did not return expected JSON.");
                    }
                }
            } catch (error) {
                alert("An error occurred: " + error.message);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>