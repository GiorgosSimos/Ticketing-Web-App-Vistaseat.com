<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Make Payment | Vistaseat.com</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Hidden Spinner overlay -->
    <div id="spinnerOverlay" class="position-fixed top-0 start-0 w-100 h-100
            d-flex justify-content-center align-items-center bg-dark bg-opacity-50 invisible"
         style="z-index: 1055;"> <!-- higher than modal backdrop -->
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Processing…</span>
        </div>
    </div>

    <div th:if="${booking.status == CONFIRMED}"
         class="d-flex flex-column align-items-center justify-content-center p-5 noticeStyle">
        <figure class="app-logo">
            <img th:src="@{/images/logo.png}" alt="logo">
        </figure>
        <figure>
            <img th:src="@{/images/tick_symbol.png}" alt="tick_symbol">
        </figure>
        <h4 class="mb-4">This booking is confirmed</h4>
        <div class="d-flex justify-content-center">
            <a th:href="@{'/api/bookingComplete/' + ${booking.id}}" class="btn btn-dark me-2">
                <i class="bi bi-ticket-detailed me-2"></i>
                View Booking Details
            </a>
            <a href="/home" class="btn btn-outline-light text-black">
                <i class="bi bi-house-door-fill me-2"></i>
                Back to Vistaseat.com
            </a>
        </div>
    </div>

    <div th:if="${booking.status == CANCELLED}"
         class="d-flex flex-column align-items-center justify-content-center p-5 noticeStyle">
        <figure class="app-logo">
            <img th:src="@{/images/logo.png}" alt="logo">
        </figure>
        <figure>
            <img th:src="@{/images/warning_symbol.png}" alt="warning_symbol">
        </figure>
        <h4 class="mb-4">This booking is canceled or has expired</h4>
        <div class="d-flex justify-content-center">
            <a th:href="@{'/api/events/' + ${booking.eventId}}" class="btn btn-dark me-2">
                <i class="bi bi-calendar2-event me-2"></i>
                Back to Event
            </a>
            <a href="/home" class="btn btn-outline-light text-black">
                <i class="bi bi-house-door-fill me-2"></i>
                Back to Vistaseat.com
            </a>
        </div>
    </div>


    <div th:if="${booking.status == PENDING}"
         class="d-flex justify-content-center">
        <div class="payment-layout container p-5 m-4">
            <!-- Payment label Section-->
            <section class="label-section">
                <figure class="payment-page-image my-3">
                    <img src="/images/logo.png" alt="site logo">
                </figure>
                <h2 class="text-center fw-bold mb-4">Vistaseat.com</h2>
                <span class="fw-semibold d-block mb-1"
                      th:text="${booking.numberOfTickets} + ' tickes for: ' + ${event.name}"></span>
                <span class="fw-semibold d-block mb-1"
                      th:text="${event.venueName}"></span>
                <span class="fw-semibold d-block mb-1"
                      th:text="${#temporals.format(occurrenceDateTime,
                                            'EEEE dd MMMM yyyy - ''Time'' HH:mm')}"></span>
                <div class="row justify-content-between my-3">
                    <div class="col-12 col-md-10 col-lg-12">
                        <table class="table table-striped table-borderless table-reservation table-wrapper">
                            <tr>
                                <th>Tickets Cost:</th>
                                <th th:text="${booking.ticketsPrice + ' €'}">0.1€</th>
                            </tr>
                            <tr>
                                <th>Service Fee:</th>
                                <th th:text="${booking.serviceFee + ' €'}">0.1€</th>
                            </tr>
                            <tr>
                                <th>Total Cost:</th>
                                <th th:text="${booking.totalAmount + ' €'}" th:value="${booking.totalAmount}">8.1€</th>
                            </tr>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Payment methods Section-->
            <section class="payment-details-section">
                <!-- Payment methods Logos -->
                <div class="mt-0">
                    <!-- HTML -->
                    <figure class="payments-logo">
                        <a href="https://www.paypal.com/how-paypal-works" title="How PayPal Works" target="_blank" rel="noopener">
                            <img src="https://www.paypalobjects.com/webstatic/mktg/logo/AM_mc_vs_dc_ae.jpg"
                                 alt="PayPal Acceptance Mark" />
                        </a>
                    </figure>
                </div>
                <!-- Tabs header -->
                <div class="d-flex justify-content-center mt-3 mb-2">
                    <ul class="nav nav-pills mb-3" id="paymentTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="card-tab"
                                    data-bs-toggle="tab" data-bs-target="#card-pane"
                                    type="button" role="tab" aria-controls="card-pane" aria-selected="true">
                                <i class="bi bi-credit-card-2-back me-1"></i>
                                Credit or Debit Card
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="paypal-tab"
                                    data-bs-toggle="tab" data-bs-target="#paypal-pane"
                                    type="button" role="tab" aria-controls="paypal-pane" aria-selected="false">
                                <i class="bi bi-paypal me-1"></i>
                                PayPal
                            </button>
                        </li>
                    </ul>
                </div>
                <!-- Tabs content -->
                <div class="tab-content" id="paymentTabsContent">
                    <!--Card Payment Pane-->
                    <div class="tab-pane fade show active" id="card-pane" role="tabpanel" aria-labelledby="card-tab">
                        <form id="cardForm"
                              th:action="@{'/api/payments/' + ${booking.id} + '/card-sim'}"
                              method="POST"
                              class="border p-3 rounded shadow-sm">
                            <!-- Hidden inputs -->
                            <input type="hidden" name="bookingId" th:value="${booking.id}">
                            <input type="hidden" name="totalAmount" th:value="${booking.totalAmount}">

                            <!-- Card details -->
                            <div class="mb-3">
                                <label for="cardNumber" class="form-label">Card number</label>
                                <input id="cardNumber"
                                       name="cardNumber"
                                       type="text"
                                       inputmode="numeric"
                                       autocomplete="cc-number"
                                       placeholder="1234 5678 9012 3456"
                                       pattern="^(?:\d{4}\s?){4}$"
                                       maxlength="19"
                                       class="form-control"
                                       title="Enter the 16-digit number on the front of your card"
                                       required>
                                <div class="invalid-feedback">
                                    That card number looks invalid. Check the digits and try again.
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="cardHolderName" class="form-label">Card Holder's Name</label>
                                <input id="cardHolderName"
                                       name="cardHolderName"
                                       type="text"
                                       inputmode="text"
                                       autocomplete="cc-name"
                                       pattern="^[A-Za-zÀ-ÿ\s]{2,40}$"
                                       class="form-control"
                                       title="Name as printed on the card (letters and spaces only)"
                                       required>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="exp" class="form-label">Expiry Date (MM/YY)</label>
                                    <input id="exp"
                                           name="expiry"
                                           type="text"
                                           inputmode="numeric"
                                           placeholder="MM/YY"
                                           pattern="^(0[1-9]|1[0-2])\/\d{2}"
                                           maxlength="5"
                                           class="form-control"
                                           title="Two-digit month and two-digit year, e.g. 05/28"
                                           required>
                                </div>
                                <div class="col-md-6">
                                    <label for="cvv" class="form-label">CVV</label>
                                    <input id="cvv"
                                           name="cvv"
                                           type="text"
                                           inputmode="numeric"
                                           autocomplete="cc-csc"
                                           pattern="^\d{3}"
                                           minlength="3" maxlength="3"
                                           class="form-control"
                                           title="3-digit code on the back of your card"
                                           required>
                                </div>
                            </div>

                            <div class="text-end mt-5">
                                <button id="cardPayButton" class="btn btn-primary rounded-pill fs-5 w-100"
                                        type="submit">Pay €<span th:text="${booking.totalAmount}">0.00</span></button>
                            </div>
                        </form>
                    </div>

                    <!-- PayPal Pane -->
                    <div class="tab-pane fade" id="paypal-pane" role="tabpanel" aria-labelledby="paypal-tab">
                        <div id="paypal-button-container"></div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Simulate payment process -->
    <script>
        function showSpinner() {
            document.getElementById("spinnerOverlay").classList.remove('invisible');
        }

        function hideSpinner() {
            document.getElementById("spinnerOverlay").classList.add('invisible');
        }

        document.querySelector('#cardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('cardPayButton');
            btn.disabled = true;    // prevent double-clicks
            showSpinner();

            const formData = new FormData(e.target);    // includes card fields + hidden inputs

            try {
                const res = await fetch(e.target.action, {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) throw new Error("Payment failed.");

                /* Simulate 5-sec processing latency */
                setTimeout(() => {
                    window.location = `/api/bookingComplete/${formData.get('bookingId')}`;
                }, 5000);
            } catch (error) {
                hideSpinner();
                btn.disabled = false;
                alert(error.message);
            }
        });
    </script>

    <!-- Format Card Number with spaces & Validate using Luhn's algorithm-->
    <script type="module">
        const form = document.getElementById('cardForm');
        const cardInput = document.getElementById('cardNumber');

        // Keep only digits, insert a space every 4
        cardInput.addEventListener('input', () => {
            let digits = cardInput.value.replace(/\D/g, '').slice(0, 16);
            cardInput.value = digits.replace(/(\d{4})(?=\d)/g, '$1 ').trim();

            // Validate as soon as 16 digits are present
            if (digits.length === 16) {
                setCardValidity(luhnCheck(digits));
            } else {
                clearCardValidity(); // neither valid nor invalid while typing
            }
        });

        // Validate on blur too
        cardInput.addEventListener('blur', () => {
            const digits = cardInput.value.replace(/\D/g, '');
            if (digits.length === 16) setCardValidity(luhnCheck(digits));
        });

        // On submit: strip spaces and block submission if invalid
        form.addEventListener('submit', (e) => {
            const digits = cardInput.value.replace(/\D/g, '');
            const ok = digits.length === 16 && luhnCheck(digits);
            if (!ok) {
                e.preventDefault();
                setCardValidity(false);
                cardInput.reportValidity();
                return;
            }
            // send pure digits to the server
            cardInput.value = digits;
        });

        // Luhn's algorithm
        function luhnCheck(cardNumberStr) {
            let sum = 0;
            let doubleDigits = false;
            for (let i = cardNumberStr.length - 1; i >= 0; i--) {
                let digit = cardNumberStr.charCodeAt(i) - 48;
                if (doubleDigits) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
                doubleDigits = !doubleDigits;
            }
            return sum % 10 === 0;
        }

        // Validate and Apply the corresponding Bootstrap styles
        function setCardValidity(isValid) {
            if (isValid) {
                cardInput.setCustomValidity('');
                cardInput.classList.remove('is-invalid');
                cardInput.classList.add('is-valid');
            } else {
                cardInput.setCustomValidity('Invalid Card Number');
                cardInput.classList.remove('is-valid');
                cardInput.classList.add('is-invalid');
            }
        }

        function clearCardValidity() {
            cardInput.setCustomValidity('');
            cardInput.classList.remove('is-valid','is-invalid');
        }

    </script>

    <script type="module">
        const expInput = document.getElementById('exp');
        const form = document.getElementById('cardForm');

        expInput.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');      // Strip non-digits
            if (v.length > 2) v = v.slice(0,2) + '/' + v.slice(2,4); // Auto-insert slash
            e.target.value = v;
            validateExpiry(); // run live validation as user types
        });

        // Upper case cardholder's name
        document.getElementById('cardHolderName')
            .addEventListener('input', e => e.target.value = e.target.value.toUpperCase());

        // Add expiry-date validation
        function validateExpiry() {
            const val   = expInput.value.trim();
            const match = /^(\d{2})\/(\d{2})$/.exec(val);

            if (!match) {                   // wrong format – let pattern do the job
                expInput.setCustomValidity('');
                return;
            }

            const month = parseInt(match[1], 10);
            const year  = 2000 + parseInt(match[2], 10);   // '28' → 2028

            const today  = new Date();
            const thisMo = today.getMonth() + 1;           // 1–12
            const thisYr = today.getFullYear();

            const inFuture = year > thisYr ||
                (year === thisYr && month >= thisMo);

            expInput.setCustomValidity(
                inFuture ? '' : 'Card has expired'
            );
        }

        // Re-validate on form submit
        form.addEventListener('submit', e => {
            validateExpiry();
            if (!form.checkValidity()) {    // triggers browser tooltip if invalid
                e.preventDefault();
                form.reportValidity();
            }
        });
    </script>

    <!-- PayPal SDK with Thymeleaf -->
    <script th:src="@{https://www.paypal.com/sdk/js(client-id=${@environment.getProperty('paypal.client-id')},currency='EUR',intent='capture')}"></script>

    <script th:inline="javascript">
        // Get the booking id
        const bookingId = /*[[${booking.id}]]*/ 0;
        let paypalRendered = false;

        async function extractError(res) {
            const text = await res.text();                // read ONCE
            if (!text) return `${res.status} ${res.statusText}`;
            try {
                const j = JSON.parse(text);
                return j.error || j.message || text;
            } catch {
                return text;
            }
        }

        function renderPayPalButtons() {
            if (paypalRendered || !window.paypal) return;

            const container = document.getElementById('paypal-button-container');
            if (!container) {
                // No container on this page/state; skip rendering silently.
                return;
            }

            paypalRendered = true;
            // Initialize and render PayPal’s smart button. This loads PayPal’s UI and wires up your callbacks.
            // The SDK will handle opening the PayPal popup/overlay, login, approval UI, etc.
            paypal.Buttons({
                // When the user clicks the button → create the order (server-side)
                createOrder: async () => {
                    const response = await fetch(`/api/payments/${bookingId}/paypal/order`, { method: "POST" });
                    if (!response.ok) {
                        const message = await extractError(response);
                        throw new Error(message);
                    }
                    const data = await response.json();
                    return data.id; // PayPal order ID
                },
                // After the buyer approves in PayPal → capture on the server. PayPal calls onApprove with orderID.
                // You do not capture on the client; you POST the orderID to your backend,
                // which performs the secure capture with PayPal and, on success, triggers
                // your existing paymentService.paymentCompleted(bookingId).
                // Then you redirect to the order-complete page (tickets shown).
                onApprove: async (data) => {
                    const response = await fetch(`/api/payments/paypal/capture`, {
                        method: 'POST',
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({orderId: data.orderID, bookingId})
                    });

                    if (!response.ok) {
                        const message = extractError(response);
                        alert(message);
                        return;
                    }
                    window.location.href = `/api/bookingComplete/${bookingId}`;
                },

                onError: (err) => {
                    console.error(err);
                    alert(err?.message || "PayPal error. Please try again.");
                }
            }).render(container);
        }

        // Render when the PayPal tab is shown (Bootstrap 5)
        const payPalTab = document.querySelector('[data-bs-target="#paypal-pane"]');
        if (payPalTab) {
            payPalTab.addEventListener('shown.bs.tab', renderPayPalButtons);
        }

        // If the PayPal pane could be initially active, render on DOM ready too
        document.addEventListener('DOMContentLoaded', renderPayPalButtons);
    </script>

</body>
</html>