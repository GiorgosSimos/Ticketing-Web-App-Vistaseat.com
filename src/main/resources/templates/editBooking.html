<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>View Booking | Vistaseat.com</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/adminStyle.css}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/admin.js}" defer></script>
</head>
<body>
    <!-- Include Header-->
    <div th:replace="fragments/adminHeader :: adminHeader(${firstName}, ${lastName})"></div>

    <!-- Alert messages for changes made -->
    <div th:if="${message}" class="alert alert-success" id="success-alert" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" id="access-denied-alert" th:text="${error} "></div>

    <!-- Title Section-->
    <section class="container pt-5">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex flex-column">
                <div class="d-flex align-items-center">
                    <i class="bi bi-receipt-cutoff fs-2 me-2"></i>
                    <h2 class="mb-0">Booking Details</h2>
                </div>
                <p>Modify booking details, change dates, or cancel reservation</p>
            </div>

            <!-- Cancel Booking Button -->
            <button class="btn btn-danger"
                    type="button"
                    id="cancelBookingBtn"
                    th:attr="
                             data-booking-id=${booking.id},
                             data-tickets=${booking.numberOfTickets},
                             data-total-amount=${booking.totalAmount}
                            "
                    th:with="
                             isPast=${booking.occurrenceDate.isBefore(CURRENT_DATETIME)},
                             alreadyCancelled=${booking.status == CANCELLED}
                            "
                    th:disabled="${isPast or alreadyCancelled}"
                    th:classappend="${(isPast or alreadyCancelled)} ? ' is-disabled' : ''">
                <i class="bi bi-x-circle-fill me-1"></i>
                Cancel Booking
            </button>
        </div>
        <hr>
    </section>

    <!-- Order Details Section -->
    <section class="container pb-5">
        <div class="booking-details-layout">

            <!-- Left side: 70% -->
            <div class="d-flex flex-column">
                <!-- Booking details Card -->
                <div class="booking-details-card mb-4">
                    <div class="d-flex py-2 two-column-span">
                        <i class="bi bi-receipt-cutoff fs-3 me-3"></i>
                        <h3 class="fw-semibold mt-1">Order Details</h3>
                    </div>
                    <label class="text-muted">Booking Number</label>
                    <label class="text-muted">Booked On</label>
                    <span class="fw-semibold" th:text="'No. ' + ${booking.id}">No. 34</span>
                    <span class="fw-semibold"
                          th:text="${#temporals.format(booking.bookingDate,
                           'MMM d, yyyy ''at'' h:mm a')}">No. 34</span>

                    <hr class="two-column-span">

                    <label class="text-muted">Status</label>
                    <label class="text-muted">Total Amount</label>
                    <span class="booking-status-badge badge badge-rounded-pill "
                          th:classappend="${booking.status == CONFIRMED} ? 'bg-success' : 'bg-danger'"
                          th:text="${booking.status}">CONFIRMED</span>
                    <span class="fw-semibold" th:text="${booking.totalAmount} + '€'">27€</span>
                </div>
                <!-- Event Information Card -->
                <div class="booked-event-info-flex-style-card mb-4">
                    <div class="d-flex">
                        <i class="bi bi-calendar2-event-fill fs-3 me-3"></i>
                        <h3 class="fw-semibold mt-1">Event Information Details</h3>
                    </div>

                    <article class="booked-event-information-card">
                        <!-- 30% – Event image -->
                        <div class="booked-event-information-card-image">
                            <img th:src="@{${eventCard.eventImageURL}}" alt="event_image">
                        </div>
                        <!-- 70% – Event info -->
                        <div class="booked-event-information-card-body">
                            <div class="event-type two-column-span"
                                 th:text="${eventCard.eventType}">CINEMA</div>
                            <h2 class="event-title two-column-span"
                                th:text="${booking.eventName}">Nuovo Cinema Paradiso</h2>
                            <p class="event-description two-column-span"
                               th:text="${eventCard.eventDescription}">Event Description</p>

                            <div class="event-meta">
                                <span class="meta-label">
                                    <i class="bi bi-geo-fill"></i>
                                    Venue:
                                </span>
                                <span class="meta-value"
                                      th:text="${eventCard.eventVenueName}">Cinema Open Air - Starlit Sky
                                </span>

                                <span class="meta-label">
                                    <i class="bi bi-calendar-week"></i>
                                    Date:
                                </span>
                                <span class="meta-value"
                                      th:text="${#temporals.format(occurrenceDateTime,
                                      'MMM d, yyyy ''at'' h:mm a')}">Aug 3, 2025 at 1:15PM</span>

                                <span class="meta-label">
                                    <i class="bi bi-hourglass"></i>
                                    Duration:
                                </span>
                                <span class="meta-value"
                                      th:text="|${occurrenceDuration / 60}h ${occurrenceDuration % 60}m|">2h 53m</span>
                            </div>
                        </div>
                    </article>
                </div>

                <!-- Change to Different Showtime -->
                <div class="available-occurrences-container">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-week fs-2 me-2"></i>
                        <h2 class="mb-0">Change to Different Showtime</h2>
                    </div>
                    <!-- No occurrences exist -->
                    <div th:if="${occurrenceCount == 0}"
                         class="empty-state d-flex flex-column align-items-center text-center">
                        <i class="bi bi-calendar3 empty-icon fs-2 mb-3"></i>
                        <h3 class="fw-semibold mb-1">Sorry, no occurrences found!</h3>
                    </div>
                    <!-- Other occurrences -->
                    <div th:each="occurrenceCard :${occurrenceCards}" class="text-decoration-none mb-4">
                        <button type="button"
                                class="occurrence-select btn p-0 border-0 bg-transparent text-start w-100"
                                th:attr="
                                    data-occurrence-id=${occurrenceCard.occurrenceId},
                                    data-datetime=${#temporals.format(occurrenceCard.dateTime, 'EEEE, MMM d, yyyy h:mm a')},
                                    data-venue=${occurrenceCard.venueName}
                                    "
                                th:with="
                                        isPast=${occurrenceCard.dateTime.isBefore(CURRENT_DATETIME)},
                                        isCurrent=${occurrenceCard.occurrenceId == booking.occurrenceId ? true : false},
                                        isSoldOut=${occurrenceCard.soldOut},
                                        notEnoughTickets=${booking.numberOfTickets > occurrenceCard.availableSeats}
                                        "
                                th:disabled="${isPast or isCurrent or isSoldOut or notEnoughTickets}"
                                th:classappend="${(isPast or isCurrent)} ? ' is-disabled' : ''">
                            <div class="book-occurrence-card">
                                <div class="availability-ribbon"
                                     th:classappend="${occurrenceCard.availabilityLevel.color}">
                                </div>
                                <div class="occurrence-details-grid col-lg-6 col-md-4 col-ms-2 mx-2">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-calendar-event me-2"></i>
                                        <span th:text="${#temporals.format(occurrenceCard.dateTime, 'EEEE, MMM d, yyyy')}"
                                              class="fw-semibold mb-0">Wednesday, Dec 23, 2024
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-clock me-2"></i>
                                        <span th:text="${#temporals.format(occurrenceCard.dateTime, 'h:mm a')}"
                                              class="fw-semibold mb-0">7:30 PM
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center mb-0 two-column-span">
                                        <i class="bi bi-geo-alt me-2"></i>
                                        <span th:text="${occurrenceCard.venueName}" class="fw-semibold mb-0">
                                        Athens Open Theatre
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center text-muted ms-4 mb-2 two-column-span">
                                        <span th:text="${occurrenceCard.venueStreet} + ' ' + ${occurrenceCard.venueNumber} +
                                              ' ' + ${occurrenceCard.venueCity} + ' ' + ${occurrenceCard.venueZipcode()}"
                                              class="mb-0">Aiolou 69, Athens 64100
                                        </span>
                                    </div>
                                </div>
                                <div class="availability-badge">
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge rounded-pill"
                                              th:text="${occurrenceCard.availabilityLevel.label}"
                                              th:classappend="${occurrenceCard.availabilityLevel.badge}">
                                            Available
                                        </span>
                                        <span class="text-muted fs-6"
                                                th:text="${occurrenceCard.availableSeats + ' of '
                                                       + occurrenceCard.initialSeats + ' left'}">
                                            10 of 15 left
                                        </span>
                                    </div>
                                </div>
                                <div class="booking-price">
                                    <p th:text="${occurrenceCard.price} + '€'" class="mb-0 fw-bold">From 89€</p>
                                    <p class="text-muted">per ticket</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right side: 30% -->
            <div class="d-flex flex-column">
                <!-- Payment Details -->
                <div class="booking-details-card mb-4">
                    <div class="d-flex py-2 two-column-span">
                        <i class="bi bi-credit-card-fill fs-3 me-3"></i>
                        <h3 class="fw-semibold">Payment Details</h3>
                    </div>
                    <label th:text="'Subtotal (' + ${booking.numberOfTickets} + ' tickect(s))'">
                        Number of tickets
                    </label>
                    <span class="d-flex justify-content-end fw-semibold"
                          th:text="${booking.ticketsPrice} + '€'">200€</span>

                    <label>Service Fee</label>
                    <span class="d-flex justify-content-end fw-semibold"
                          th:text="${booking.serviceFee} + '€'">200€</span>

                    <hr class="two-column-span">

                    <label class="text-muted">Total Amount</label>
                    <span class="d-flex justify-content-end fw-semibold"
                          th:text="${booking.totalAmount} + '€'">27€</span>

                    <hr class="two-column-span">

                    <p class="text-muted my-2 two-column-span"
                       th:text="${transactionID != null} ? 'Order paid on: ' + ${#temporals.format(paymentDate,
                    'MMM d, yyyy ''at'' h:mm:ss a')} + ' with ' + ${paymentMethod} : 'Incomplete Transaction'">
                        Payment Method
                    </p>
                    <p class="text-muted two-column-span"
                       th:text="${transactionID != null} ?'Transaction ID: ' + ${transactionID} : 'Transaction ID: -'">Transaction ID</p>
                </div>
                <!-- Contact Info Card-->
                <div class="contact-info-card mb-4">
                    <div class="d-flex">
                        <i class="bi bi-person-rolodex fs-3 me-3"></i>
                        <h3 class="fw-semibold mt-1">Contact Information</h3>
                    </div>
                    <div class="d-flex">
                        <i class="bi bi-person-fill fs-6 me-2"></i>
                        <span class="fw-semibold" th:text="${booking.firstName} + ' ' +${booking.lastName}">
                            Full Name</span>
                    </div>
                    <div class="d-flex">
                        <i class="bi bi-envelope-at-fill fs-6 me-2"></i>
                        <span class="fw-semibold" th:text="${booking.email}">Email</span>
                    </div>
                    <div class="d-flex">
                        <i class="bi bi-telephone-fill fs-6 me-2"></i>
                        <span class="fw-semibold" th:text="${booking.phoneNumber}">Phone</span>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Cancel Booking Modal -->
    <div class="modal fade" id="cancelBookingModal" tabindex="-1" aria-labelledby="cancelBookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="cancelBookingModalLabel">Confirm Booking Cancellation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-danger d-flex align-items-start gap-2 mb-2" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div>
                            WARNING: You are about to cancel this booking.
                            This action cannot be undone.
                            Total amount will be refunded to the client.
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Booking to be Cancelled</div>
                        <div class="fw-semibold">
                            <span th:text="${booking.eventName}"></span>
                        </div>
                        <div class="fw-semibold">
                            <span th:text="${#temporals.format(occurrenceDateTime, 'EEEE, MMM d, yyyy h:mm a')}"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Cancellation Details</div>
                        <div class="fw-semibold">
                            <span th:text="${'Customer Name: ' + booking.firstName + ' ' + booking.lastName}"></span>
                        </div>
                        <div class="fw-semibold">
                            <span id="numberOfSeats">5</span>
                        </div>
                        <div class="fw-semibold" id="totalAmount">50€</div>
                    </div>
                </div>

                <div class="modal-footer">
                    <form th:action="@{'/adminDashboard/manageBookings/viewBooking/' + ${booking.id} + '/cancel-refund'}"
                          method="post" id="cancelBookingForm" class="d-inline">

                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmCancelBtn">Confirm</button>
                    </form>
                </div>

            </div>
        </div>
    </div>


    <!-- Reschedule Confirmation Modal -->
    <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="rescheduleModalLabel">Confirm Booking Reschedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="alert alert-warning d-flex align-items-start gap-2 mb-2" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <div>
                            You are about to modify this booking. Please review the changes below before confirming.
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Current booking</div>
                        <div class="fw-semibold">
                            <span th:text="${#temporals.format(occurrenceDateTime, 'EEEE, MMM d, yyyy h:mm a')}"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">Move to</div>
                        <div class="fw-semibold">
                            <span id="newOccurrenceWhen">—</span>
                        </div>
                        <div class="text-muted" id="newOccurrenceVenue"></div>
                    </div>
                </div>

                <div class="modal-footer">
                    <form th:action="@{'/adminDashboard/manageBookings/viewBooking/' + ${booking.id} + '/reschedule'}"
                          method="post" id="rescheduleForm" class="d-inline">
                        <input type="hidden" name="newOccurrenceId" id="newOccurrenceId">

                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="confirmRescheduleBtn">Confirm</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Include Footer-->
    <div th:replace="fragments/adminFooter :: footer"></div>

    <!-- Cancel Booking -->
    <script th:inline="javascript">
        (function() {
            const modalEl = document.getElementById('cancelBookingModal');
            const modal = new bootstrap.Modal(modalEl);

            const numberOfSeats = document.getElementById('numberOfSeats');
            const totalAmount = document.getElementById('totalAmount');

            document.querySelectorAll('#cancelBookingBtn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const seats = btn.getAttribute('data-tickets');
                    const amount = btn.getAttribute('data-total-amount');

                    numberOfSeats.textContent = 'Number of booked seats: '+seats || '—';
                    totalAmount.textContent = 'Amount to be refunded ' + amount + '€' || '—';

                    modal.show();
                });
            });
        })();
    </script>

    <!-- Booking Reschedule -->
    <script th:inline="javascript">
        (function() {
            const modalEl = document.getElementById('rescheduleModal');
            const modal = new bootstrap.Modal(modalEl);

            const newOccurrenceIdInput = document.getElementById('newOccurrenceId');
            const newOccurrenceWhen = document.getElementById('newOccurrenceWhen');
            const newOccurrenceVenue = document.getElementById('newOccurrenceVenue');

            document.querySelectorAll('.occurrence-select').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-occurrence-id');
                    const when = btn.getAttribute('data-datetime');
                    const venue = btn.getAttribute('data-venue');

                    newOccurrenceIdInput.value = id;
                    newOccurrenceWhen.textContent = when || '—';
                    newOccurrenceVenue.textContent = venue || '';

                    modal.show();
                });
            });
        })();
    </script>

</body>
</html>